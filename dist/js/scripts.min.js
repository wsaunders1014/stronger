var fileReady=!1,twtShared=!1,fbShared=!1;$(document).ready(function(){function e(){fileReady=!1,$("#save-btn").hide().removeClass("disabled"),$("#create").find("label").show(),$("#share").hide(),$("#video").val(""),$("#create-btn").removeClass("disabled"),$("progress").hide(),$("#spinner").hide(),$("#create").show()}function t(e){console.log(e),"connected"==e.status?($("#share-modal").show().find("h2").html("Share to Facebook"),$("#share-btn").html('SHARE TO FACEBOOK<img class="share-spinner" src="img/spinner.svg" alt="Processing"/>').removeClass("twitter").addClass("facebook")):(console.log("test"),"true"==session.mobile?location.href="https://www.facebook.com/v2.10/dialog/oauth?client_id=1956267324660722&redirect_uri=https://strengthdefinesus.com/&response_type=token&scope=publish_actions,user_videos,user_photos":FB.login(function(e){console.log(e),"connected"==e.status&&($("#share-modal").show().find("h2").html("Share to Facebook"),$("#share-btn").html('SHARE TO FACEBOOK<img class="share-spinner" src="img/spinner.svg" alt="Processing"/>').removeClass("twitter").addClass("facebook"))},{scope:"public_profile, user_videos,user_photos,publish_actions"}))}window.self==window.top?console.log("parent"):console.log("iframe"),$.ajaxSetup({cache:!0}),$.getScript("//connect.facebook.net/en_US/sdk.js",function(){FB.init({appId:"1956267324660722",version:"v2.10"})});var s="steel",i="true"==session.mobile?"touchstart":"click";if(session.url&&session.type){if($("#create").hide(),"true"==session.mobile&&"video"==session.type&&$("#instagram-btn").hide(),$("#share").show(),"video"==session.type){var o=document.createElement("VIDEO");o.setAttribute("controls","controls"),o.setAttribute("autoplay","autoplay"),o.setAttribute("muted","muted"),o.setAttribute("loop","loop"),o.setAttribute("playsinline","true"),o.setAttribute("src",session.aws),$("#preview").html("").append(o),o.addEventListener("canplay",function(){$("#preview").find("video").height()<=.5625*$("#preview").find("video").width()?$("#preview").find("video").addClass("landscape"):$("#preview").find("video").addClass("portrait")}),o.load(),o.play()}else{var a=new Image;a.onload=function(){a.height<=.5625*a.width?a.setAttribute("class","landscape"):a.setAttribute("class","portrait")},a.onerror=function(){e();var t=document.createElement("VIDEO");t.setAttribute("controls","controls"),t.setAttribute("autoplay","autoplay"),t.setAttribute("muted","muted"),t.setAttribute("loop","loop"),t.setAttribute("playsinline","true"),t.setAttribute("class","landscape"),t.setAttribute("src","media/preview.mp4"),$("#preview").html("").append(t),t.load(),t.play()},a.src=session.url,$("#preview").html("").append(a)}$("#instagram-btn").find("a").attr("href",session.aws),$("#facebook-btn").attr("data-url",session.aws),$("#twitter-btn").attr("data-url",session.url)}$(".square").on("click touchstart tap",function(e){e.preventDefault(),e.stopPropagation();var t=$(this).attr("id");switch($(".square").removeClass("active"),$(this).addClass("active"),s=t,t){case"steel":$("#preview-overlay").find(".upper").attr("src","img/overlay_text.png?"+Date.now());break;case"black":$("#preview-overlay").find(".upper").attr("src","img/overlay_textb.png?"+Date.now());break;case"white":$("#preview-overlay").find(".upper").attr("src","img/overlay_textw.png?"+Date.now())}}),$("#save-btn").on("click",function(t){t.preventDefault(),$("progress").show(),$("#save-btn").addClass("disabled"),$(".options").css({visibility:"hidden"});var i=new FormData($("#video-upload")[0]);i.append("color",s),$.ajax({url:"/upload",type:"POST",contentType:!1,data:i,processData:!1,xhr:function(){var e=$.ajaxSettings.xhr();return e.upload&&e.upload.addEventListener("progress",function(e){e.lengthComputable&&($("progress").attr({value:e.loaded,max:e.total}),e.loaded>=e.total&&($("progress").hide(),$("#spinner").show(),$(".error").html("Filed uploaded. Now encoding...")))},!1),e}}).done(function(t){if(fileReady=!1,console.log(t),t.error)$("#spinner").hide(),$(".error").html(t.message),e();else{if($("#spinner").hide(),$("progress").hide(),$("#preview-overlay").hide(),"video"==t.type){var s=document.createElement("VIDEO");s.setAttribute("controls","controls"),s.setAttribute("autoplay","autoplay"),s.setAttribute("muted","muted"),s.setAttribute("loop","loop"),s.setAttribute("playsinline","true"),s.setAttribute("src",t.aws_url),$("#preview").html("").append(s),s.addEventListener("canplay",function(){$("#preview").find("video").height()<=.5625*$("#preview").find("video").width()?($("#preview").find("video").addClass("landscape"),$("#preview-overlay").css({width:"100%"})):($("#preview").find("video").addClass("portrait"),$("#preview-overlay").css({width:$("#preview").find("video").width()})),$(".options").css({left:($("#preview").width()-$("#preview").find("video").width())/2})}),s.load(),s.play(),"true"==session.mobile&&$("#instagram-btn").hide()}else{var i=new Image;i.onload=function(){i.height<=.5625*i.width?i.setAttribute("class","landscape"):i.setAttribute("class","portrait")},i.src=t.server_url,$("#preview").html("").append(i)}$("#create").hide(),$("#share").show(),session.aws=t.aws_url,session.url=t.server_url,session.type=t.type,$("#instagram-btn").find("a").attr("href",t.aws_url),$("#facebook-btn").attr("data-url",t.aws_url),$("#twitter-btn").attr("data-url",t.server_url),console.log("Time Elapsed: "+t.timeElapsed+" seconds")}})}),$("#video").on("change",function(t){if(t.preventDefault(),!fileReady){$(".error").html("");var s=this.files[0];if($("#preview").width(),this.files[0].size/1e3/1024>150)return $(".error").html("File size must be under 150mb."),e(),!1;if(!s.type.match("image/*")&&!s.type.match("video/*"))return $(".error").html("Invalid file type."),e(),!1;var i=URL.createObjectURL(s);if($(".options").css({visibility:"visible"}),s.type.match("video/*")){var o=document.createElement("VIDEO");o.setAttribute("controls","controls"),o.setAttribute("autoplay","autoplay"),o.setAttribute("muted","muted"),o.setAttribute("loop","loop"),o.setAttribute("playsinline","true"),o.setAttribute("src",i),console.log(o.videoWidth),$("#preview").html("").append(o),o.addEventListener("canplay",function(){console.log(o.videoWidth),o.videoWidth<300||o.videoHeight<300?($(".error").html("Video size must be at least 300 x 300 pixels."),e()):($("#preview").find("video").height()<=.5625*$("#preview").find("video").width()?($("#preview").find("video").addClass("landscape"),$("#preview-overlay").css({width:"100%"})):($("#preview").find("video").addClass("portrait"),$("#preview-overlay").css({width:$("#preview").find("video").width()})),$(".options").css({left:($("#preview").width()-$("#preview").find("video").width())/2}))}),o.load(),o.play()}else{var a=new Image;a.onload=function(){a.width<300||a.height<300?$(".error").html("Image size must be at least 300 x 300 pixels."):a.height<.5625*a.width?a.setAttribute("class","landscape"):(a.setAttribute("class","portrait"),$("#preview-overlay").css({width:a.width}),$(".options").css({left:($("#preview").width()-a.width)/2}))},a.src=i,$("#preview").html("").append(a)}$("#preview-overlay").show(),fileReady=!0,$("#create").find("label").hide(),$("#save-btn").css({display:"inline-block"})}}),$("#restart-btn").on("click touchstart tap",function(t){t.preventDefault(),t.stopPropagation(),e()}),$("#facebook-btn").on(i,function(e){e.preventDefault(),e.stopPropagation(),FB&&FB.getLoginStatus(function(e){t(e)})}),$("#twitter-btn").on(i,function(e){e.preventDefault(),e.stopPropagation(),$.post("/authTwitter",{url:$(this).attr("data-url")}).done(function(e){window.open("https://twitter.com/oauth/authenticate?oauth_token="+e.requestToken,"shareWindow","location=0,status=0,width=800,height=400")})}),$("#share-btn").on(i,function(e){e.preventDefault(),$(".share-spinner").show(),$("#share-btn").addClass("disabled"),$(this).hasClass("twitter")?twtShared||(twtShared=!0,$.ajax({url:"/postToTwitter",type:"POST",data:{status:$("#share-modal").find("textarea").val(),url:session.url,type:session.type}}).done(function(e){console.log(e),"success"==e.status?($("#share-modal").find(".pre").hide().next().show(),$("#twitter-btn").addClass("disabled"),setTimeout(function(){$("#share-modal").hide(),$("#share-btn").removeClass("disabled"),$("#share-modal").find(".pre").show().next().hide()},2e3)):(twtShared=!1,$("#share-modal").find(".pre").hide().next().html("<h2>There was an error:</h2><p>"+e.errors+"</p>").show())})):$(this).hasClass("facebook")&&(fbShared||(fbShared=!0,"video"==session.type||-1!=session.url.indexOf(".gif")?FB.api("/me/videos","post",{file_url:session.aws,description:$("#share-modal").find("textarea").val(),title:"Strength Defines Us #strongermovie"},function(e,t){console.log(e,t),$(".share-spinner").hide(),t?(console.log(t),fbShared=!1,$("#share-btn").removeClass("disabled"),$("#share-modal").find(".pre").hide().next().html("<h3>There was an error:</h3><p>"+data.err.code+"</p>").show()):(fbShared=!0,$("#share-modal").find(".pre").hide().next().html("<h3>Posted to Facebook.</h3><p>For videos, please allow up to a few minutes for it to show.</p>").show(),setTimeout(function(){window.close()},2500))}):"image"==session.type&&-1==session.url.indexOf(".gif")&&FB.api("/me/photos","post",{caption:$("#share-modal").find("textarea").val(),url:session.aws},function(e,t){$(".share-spinner").hide(),console.log(e,t),t?(console.log(t),fbShared=!1,$("#share-btn").removeClass("disabled"),$("#share-modal").find(".pre").hide().next().html("<h3>There was an error:</h3><p>"+t.message+"</p>").show()):(fbShared=!0,$("#share-modal").find(".pre").hide().next().html("<h3>Posted to Facebook.</h3><p>For videos, please allow up to a few minutes for it to show.</p>").show(),setTimeout(function(){window.close()},2500))})))}),$(".close-btn").on("click touchstart tap",function(e){e.preventDefault(),e.stopPropagation(),$("#share-modal").hide()})});